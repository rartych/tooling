# =========================================================================================
# CAMARA Project - Pull Request Validation Workflow
#
# This GitHub Actions is a reusable workflow for validating PRs using tools configuration
# from subfolder indicated by input `configurations` variable.
#
# Validation includes:
# - release-plan.yaml validation (if changed, must be exclusive - no other changes)
# - MegaLinter for API definitions and test files
#
# CHANGELOG:
# - 2025-08-01: Initial version for v0
# - 2026-01-13: Added release-plan.yaml validation with exclusivity check
#
# USAGE:
# The action is invoked by Pull Request Validation Workflow Caller in CAMARA API repositories
#
# DOCUMENTATION:
# see https://github.com/camaraproject/tooling/tree/main/linting/docs
# =========================================================================================

name: PR validation for CAMARA Project

on:
  workflow_call:
    inputs:
      configurations:
        description: Subfolder containing tool configs to be used
        type: string
        required: false
        default: ""

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Detect changed files
        id: changes
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47
        with:
          files_yaml: |
            release_plan:
              - release-plan.yaml
            other:
              - '**'
              - '!release-plan.yaml'

      # ==================== release-plan.yaml Validation ====================
      # If release-plan.yaml changed, it must be the ONLY change in the PR
      # This ensures validation errors from rule changes don't mix with code changes

      - name: Check exclusivity
        id: exclusivity
        if: steps.changes.outputs.release_plan_any_changed == 'true'
        run: |
          if [[ "${{ steps.changes.outputs.other_any_changed }}" == "true" ]]; then
            echo "::error::release-plan.yaml must be changed in a separate PR"
            echo "## Exclusivity Check Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "release-plan.yaml changes must be in a **separate PR** from other changes." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Reason:** If release-plan.yaml changes validation rules (e.g., alpha to rc)," >> $GITHUB_STEP_SUMMARY
            echo "any new errors should be clearly attributable to the rule change, not mixed with code changes." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Please:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Remove release-plan.yaml changes from this PR" >> $GITHUB_STEP_SUMMARY
            echo "2. Create a separate PR for release-plan.yaml updates" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Validate release-plan.yaml
        if: steps.changes.outputs.release_plan_any_changed == 'true'
        id: validate
        uses: camaraproject/tooling/shared-actions/validate-release-plan@v0
        with:
          release_plan_path: release-plan.yaml
          check_files: 'true'

      - name: Report validation status
        if: always() && steps.changes.outputs.release_plan_any_changed == 'true' && steps.exclusivity.outcome != 'failure'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v8
        with:
          script: |
            const valid = '${{ steps.validate.outputs.valid }}' === 'true';
            const runUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            // Parse warnings first (needed for status description)
            const warningsStr = `${{ steps.validate.outputs.warnings }}`;
            let warnings = [];
            try {
              warnings = JSON.parse(warningsStr || '[]');
            } catch (e) {
              if (warningsStr && warningsStr.trim()) {
                warnings = [warningsStr];
              }
            }

            // Determine status description
            let description;
            if (!valid) {
              description = 'Validation failed';
            } else if (warnings.length > 0) {
              description = 'Validation passed with warnings';
            } else {
              description = 'Validation passed';
            }

            // Create separate check status (visible in PR checks list)
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: valid ? 'success' : 'failure',
              context: '--> Validate: release-plan.yaml',
              description: description,
              target_url: runUrl
            });

            if (!valid) {
              // Output errors as annotations
              const errorsStr = `${{ steps.validate.outputs.errors }}`;
              let errors = [];
              try {
                errors = JSON.parse(errorsStr || '[]');
              } catch (e) {
                errors = [errorsStr];
              }

              for (const err of errors) {
                core.error(err, {file: 'release-plan.yaml'});
              }

              // Job summary
              core.summary.addHeading('Release Plan Validation Failed', 2);
              core.summary.addList(errors);
              await core.summary.write();

              core.setFailed('Release plan validation failed');
            } else {
              if (warnings.length > 0) {
                for (const warn of warnings) {
                  core.warning(warn, {file: 'release-plan.yaml'});
                }
                core.summary.addHeading('Release Plan Validation Passed with Warnings', 2);
                core.summary.addList(warnings);
              } else {
                core.notice('Validation passed', {file: 'release-plan.yaml'});
                core.summary.addHeading('Release Plan Validation Passed', 2);
              }
              await core.summary.write();
            }

      - name: Skip validation (no release-plan changes)
        if: steps.changes.outputs.release_plan_any_changed != 'true'
        run: echo "::notice::release-plan.yaml not modified, skipping validation"

      # ==================== MegaLinter ====================
      # Runs when:
      # - release-plan.yaml was NOT changed, OR
      # - release-plan.yaml was changed AND validation passed
      # Skipped when release-plan.yaml validation fails (no point linting with invalid rules)

      - name: Checkout linting config
        if: steps.changes.outputs.release_plan_any_changed != 'true' || steps.validate.outputs.valid == 'true'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v5
        with:
          repository: camaraproject/tooling
          path: lint-config
          # using configurations from v0 floating tag
          ref: v0
          sparse-checkout: |
            linting/config/
          sparse-checkout-cone-mode: false

      - name: Copy config to workspace
        if: steps.changes.outputs.release_plan_any_changed != 'true' || steps.validate.outputs.valid == 'true'
        # --strip-trailing-slashes removes any trailing slashes from each SOURCE argument (when ${{ inputs.configurations }} is empty)
        run: cp -RT --strip-trailing-slashes ${{ github.workspace }}/lint-config/linting/config/${{ inputs.configurations }} ${{ github.workspace }}

      - name: MegaLinter
        id: ml
        if: steps.changes.outputs.release_plan_any_changed != 'true' || steps.validate.outputs.valid == 'true'
        # You can override MegaLinter flavor used to have faster performances
        # c_cpp MegaLinter Flavor https://megalinter.io/latest/flavors/c_cpp/ includes all needed linters - can be upgraded to v8
        uses: oxsecurity/megalinter/flavors/c_cpp@v9
        # configuration of Megalinter
        env:
          VALIDATE_ALL_CODEBASE: true
          PRINT_ALPACA: false
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_COMMENT_REPORTER: true
          GITHUB_STATUS_REPORTER: true
          DISABLE: COPYPASTE,SPELL,JAVASCRIPT,MARKDOWN
          # OPENAPI_SPECTRAL is deprecated but still present in Megalinter v7
          DISABLE_LINTERS: OPENAPI_SPECTRAL,YAML_PRETTIER,REPOSITORY_GRYPE,REPOSITORY_SEMGREP,REPOSITORY_DEVSKIM,REPOSITORY_KICS,REPOSITORY_TRIVY,REPOSITORY_TRIVY_SBOM,REPOSITORY_TRUFFLEHOG,REPOSITORY_CHECKOV,REPOSITORY_GITLEAKS,YAML_V8R,JAVA_PMD
          API_SPECTRAL_CONFIG_FILE: .spectral.yaml
          YAML_YAMLLINT_CONFIG_FILE: .yamllint.yaml
          GHERKIN_GHERKIN_LINT_CONFIG_FILE: .gherkin-lintrc
          API_SPECTRAL_FILTER_REGEX_INCLUDE: (code/API_definitions/)
          YAML_YAMLLINT_FILTER_REGEX_INCLUDE: (code/API_definitions/)
          GHERKIN_GHERKIN_LINT_FILTER_REGEX_INCLUDE: (code/Test_definitions/)

      - name: Archive reports
        if: (success() || failure()) && steps.ml.outcome != 'skipped'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: MegaLinter reports
          include-hidden-files: "true"
          path: |
            megalinter-reports
            mega-linter.log
